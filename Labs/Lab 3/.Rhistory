.,
margins_perc,
~ cbind(.x, pop_percent = .y %>% keep(~ .x != 0)) %>%
mutate(
across(
contains("percent"),
~ .x * 100
),
`N (population)` = pop_percent/100 * 52525134
) %>%
rename(
N = n,
Pourcentage = percent,
`Pourcentage (population)` = pop_percent
)
) %>%
map2(
.,
c("AgeSexe", "Région", "Taille agglo", "CSP"),
~ write_excel_csv2(.x, paste("Pre-weighting table ", .y, ".csv", sep = ""))
)
# Margins matrix for icarus
margins_matrix <- rbind(
c("redr_quota_1", 12, margins_perc$QUOTAS_1),
c("redr_quota_2", 12, margins_perc$QUOTAS_2),
c("redr_quota_3", 4, margins_perc$QUOTAS_3),
c("redr_quota_4", 8, margins_perc$QUOTAS_4)
)
df_weights <- calibration(data=df, marginMatrix=margins_matrix, colWeights=1, method="raking", popTotal = 52525134, pct = TRUE)
df_weights
df
df
df$CaseId
df_weighted
df_weights <- calibration(data=df, marginMatrix=margins_matrix, colWeights=1, method="raking", popTotal = 52525134, pct = TRUE)
df_weighted
df %>%
mutate(
calibration_weights = df_weights,
calibration_weights_scaled = df_weights / mean(df_weights),
)
df_weighted
df %>%
mutate(
calibration_weights = df_weights,
calibration_weights_scaled = df_weights / mean(df_weights),
)
df_weighted %>%
ggplot(
aes(x = calibration_weights_scaled)
) +
geom_density() +
theme_minimal()
# Final
df_weighted <-
df %>%
mutate(
calibration_weights = df_weights,
calibration_weights_scaled = df_weights / mean(df_weights),
)
df_weighted %>%
ggplot(
aes(x = calibration_weights_scaled)
) +
geom_density() +
theme_minimal()
# Export
df_weighted %>%
select(CaseId, calibration_weights, calibration_weights_scaled) %>%
as_factor() %>%
write_csv("ICOVAC_V4_WEIGHTS_20250409.csv")
df %>% tabyl(ECH)
df_weight_e1 <- calibration(data=df %>% filter(ECH == "Sous échantillon 1"), marginMatrix=margins_matrix, colWeights=1, method="raking", popTotal = 52525134, pct = TRUE)
df_weight_e2 <- calibration(data=df %>% filter(ECH == "Sous échantillon 2"), marginMatrix=margins_matrix, colWeights=1, method="raking", popTotal = 52525134, pct = TRUE)
df_weighted %>%
select(CaseId, calibration_weights, calibration_weights_scaled)
df_weighted %>%
select(CaseId, calibration_weights, calibration_weights_scaled) %>%
as_factor()
# Final
df_weighted <-
df %>%
mutate(
calibration_weights_tous = df_weights,
calibration_weights_tous_scaled = df_weights / mean(df_weights),
)
df_weighted %>%
ggplot(
aes(x = calibration_weights_tous_scaled)
) +
geom_density() +
theme_minimal()
df_weight_e1
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
# Export
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
)
# Export
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
write_csv("ICOVAC_V4_WEIGHTS_20250929.csv")
# Export
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
summarise(
across(
contains("scaled"),
~ sum(.x)
)
)
# Export
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
summarise(
across(
contains("scaled"),
~ sum(.x, na.rm = TRUE)
)
)
# Export
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
write_csv("ICOVAC_V4_WEIGHTS_20250929.csv")
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
)
# Export
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
write_csv("ICOVAC_V4_WEIGHTS_20250929.csv", na = "")
# Survey OW
df_svy <-
df_weighted %>%
as_factor() %>%
as_survey_design(weights = calibration_weights_tous_scaled)
map(
c("Q01_02_r", "Q03", "Q04", "Q05_R0"),
~ df_svy %>%
group_by(!!sym(.x)) %>%
summarise(
survey_total()
) %>%
select(-`_se`) %>%
rename(N = coef) %>%
mutate(Pourcentage = N / sum(N) * 100)
) %>%
map2(
.,
c("AgeSexe", "Région", "Taille agglo", "CSP"),
~ write_excel_csv2(.x, paste("Post-weighting table ", .y, ".csv", sep = ""))
)
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
)
df_weighted %>%
select(CaseId, calibration_weights_tous, calibration_weights_tous_scaled) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 1") %>%
mutate(
calibration_weights_ech1 = df_weight_e1,
calibration_weights_ech1_scaled = df_weight_e1 / mean(df_weight_e1)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>%
left_join(
df %>%
filter(ECH == "Sous échantillon 2") %>%
mutate(
calibration_weights_ech2 = df_weight_e2,
calibration_weights_ech2_scaled = df_weight_e2 / mean(df_weight_e2)
) %>%
select(CaseId, starts_with("calibration_weights"))
) %>% View()
library(tidyverse)
library(icarus)
library(haven)
library(janitor)
library(survey)
library(srvyr)
set.seed(451)
df <- read_dta("ICOVAC_V5_CAWI_20250925.dta") %>%
as_factor()
View(df)
read_sav(file.path("data", "ICOVAC_V4_CAWI_20250219.sav"))
setwd("~/Icovac/Vague 4")
read_sav(file.path("data", "ICOVAC_V4_CAWI_20250219.sav"))
read_sav(file.path("data", "ICOVAC_V4_CAWI_20250219.sav")) %>%
filter(COMPLET == 8)
df <- read_sav(file.path("data", "ICOVAC_V4_CAWI_20250219.sav")) %>%
filter(COMPLET == 8)
df <- read_sav(file.path("data", "ICOVAC_V4_CAWI_20250219.sav"))
View(df)
setwd("~/AMES/Vague 1")
df <-
read_dta("AMES_V1_CAWI_20251106.dta") %>%
as_factor()
View(df)
df <-
read_dta("AMES_V1_CAWI_20251106.dta") %>%
as_factor()
df %>% tabyl(COMPLET)
setwd("~/Icovac/Vague 4")
df <- read_sav(file.path("data", "ICOVAC_V4_CAWI_20250219.sav"))
View(df)
setwd("~/Enseignement/DS-Real-World-Pub/Labs/Lab 3")
shiny::runApp()
runApp()
runApp()
df %>%
plot_ly(
x = ~x,
y = ~y,
color = ~z,
type = 'scatter',
mode = 'markers'
)
df <-
tibble(
x = rnorm(50000),
y = runif(50000),
z = sample(c("Red", "Blue"), 50000, replace = TRUE, prob = c(0.5, 0.5))
)
df2 <-
tibble(
x = 1:100
)
df3 <-
tibble(
dpt = c("Ain", "Aisne", "Allier", "Basses-Alpes"),
region = c("Auverge-Rhône-Alpes", "Hauts-de-France", "Auverge-Rhône-Alpes", "Provence-Alpes-Côte d'Azur")
)
df %>%
plot_ly(
x = ~x,
y = ~y,
color = ~z,
type = 'scatter',
mode = 'markers'
)
df4 <-
tibble(
x = rnorm(500, 2, 10),
y = rnorm(500, 1, 1.5),
z = rnorm(500, 5, 6)
)
df4 <-
tibble(
x = rnorm(500, 2, 10),
y = rnorm(500, 1, 1.5),
z = rnorm(500, 5, 6),
team = sample(c("Red", "Blue"), 500, replace = TRUE, prob = c(0.25, 0.75))
)
df4 <-
tibble(
x = rnorm(500, 2, 10),
y = rnorm(500, 1, 1.5),
z = rnorm(500, 5, 6),
team = sample(c("Red", "Blue"), 500, replace = TRUE, prob = c(0.25, 0.75))
)
df4 %>%
plot_ly(
x = ~x,
y = ~y,
z = ~z,
color = ~team,
type = 'scatter',
mode = 'markers'
)
df4 %>%
plot_ly(
x = ~x,
y = ~y,
z = ~z,
color = ~team
) %>%
add_markers()
install.packages("randomNames")
randomNames::randomNames(500)
df4 <-
tibble(
x = rnorm(500, 2, 10),
y = rnorm(500, 1, 1.5),
z = rnorm(500, 5, 6),
team = sample(c("Red", "Blue"), 500, replace = TRUE, prob = c(0.25, 0.75)),
names = randomNames::randomNames(500)
)
df4 %>%
plot_ly(
x = ~x,
y = ~y,
z = ~z,
color = ~team,
text = ~names,
hoverinfo = "names"
) %>%
add_markers()
df4 %>%
plot_ly(
x = ~x,
y = ~y,
z = ~z,
color = ~team,
text = ~names,
hoverinfo = "names",
colors = c("#FF7777", "#7777FF")
) %>%
add_markers()
df4 %>%
plot_ly(
x = ~x,
y = ~y,
z = ~z,
color = ~team,
text = ~names,
hoverinfo = "names",
colors = c("#7777FF", "#FF7777")
) %>%
add_markers()
runApp()
runApp()
df2
gc()
df2 %>% summarise(sum(x))
df2 <-
tibble(
x = 1:100
)
df2 %>% summarise(sum(x))
df2 %>% summarise(x = sum(x)) %>% pull(x)
runApp()
library(bsicons)
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
